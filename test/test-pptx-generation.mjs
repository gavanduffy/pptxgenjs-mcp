#!/usr/bin/env node

/**
 * Test PPTX generation, save, and export functions
 * This tests the actual PptxGenJS functionality
 */

import pptxgen from 'pptxgenjs';
import { writeFileSync } from 'fs';

console.log('ðŸ§ª Testing PPTX Generation and Export\n');

// Test 1: Create a simple presentation
console.log('=== Test 1: Create Presentation ===');
const pres = new pptxgen();
pres.author = 'Test Suite';
pres.title = 'PPTX Generation Test';
pres.subject = 'Testing save and export functions';
console.log('âœ… Presentation created');

// Test 2: Add a slide with content
console.log('\n=== Test 2: Add Slide with Content ===');
const slide = pres.addSlide();
slide.addText('Testing Save and Export Functions', {
  x: 1,
  y: 1,
  w: 8,
  h: 1,
  fontSize: 32,
  bold: true,
  color: '0066CC',
});
slide.addText('This presentation was generated by the test suite', {
  x: 1,
  y: 2.5,
  w: 8,
  h: 0.5,
  fontSize: 18,
  color: '666666',
});
console.log('âœ… Slide added with text');

// Test 3: Export as base64
console.log('\n=== Test 3: Export as Base64 ===');
try {
  const base64Data = await pres.write({ outputType: 'base64' });
  console.log(`âœ… Base64 export successful`);
  console.log(`   Size: ${Math.round(base64Data.length / 1024)} KB`);
  console.log(`   Preview: ${base64Data.substring(0, 50)}...`);
  
  // Test 4: Save base64 to file
  console.log('\n=== Test 4: Save Base64 to File ===');
  const binaryString = atob(base64Data);
  const bytes = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  
  writeFileSync('/workspaces/pptxgenjs-mcp/test/test-output.pptx', bytes);
  console.log('âœ… File saved to test/test-output.pptx');
  
} catch (error) {
  console.log(`âŒ Export failed: ${error.message}`);
  console.error(error);
}

// Test 5: Test different output types
console.log('\n=== Test 5: Test Different Output Types ===');
const outputTypes = ['base64', 'arraybuffer', 'blob', 'uint8array'];

for (const outputType of outputTypes) {
  try {
    const result = await pres.write({ outputType });
    
    let size = 0;
    let type = typeof result;
    
    if (outputType === 'base64') {
      size = result.length;
      type = 'string';
    } else if (outputType === 'arraybuffer') {
      size = result.byteLength;
      type = 'ArrayBuffer';
    } else if (outputType === 'blob') {
      size = result.size;
      type = 'Blob';
    } else if (outputType === 'uint8array') {
      size = result.length;
      type = 'Uint8Array';
    }
    
    console.log(`âœ… ${outputType}: ${type}, ${size} bytes`);
  } catch (error) {
    console.log(`âŒ ${outputType}: ${error.message}`);
  }
}

// Test 6: Test with compression
console.log('\n=== Test 6: Test with Compression ===');
try {
  const uncompressed = await pres.write({ outputType: 'base64', compression: false });
  const compressed = await pres.write({ outputType: 'base64', compression: true });
  
  console.log(`âœ… Uncompressed: ${Math.round(uncompressed.length / 1024)} KB`);
  console.log(`âœ… Compressed: ${Math.round(compressed.length / 1024)} KB`);
  console.log(`   Savings: ${Math.round((1 - compressed.length / uncompressed.length) * 100)}%`);
} catch (error) {
  console.log(`âŒ Compression test failed: ${error.message}`);
}

// Test 7: Test complex presentation
console.log('\n=== Test 7: Create Complex Presentation ===');
const complexPres = new pptxgen();
complexPres.author = 'Test Suite';
complexPres.title = 'Complex Test';

// Add multiple slides with different content types
const slide1 = complexPres.addSlide();
slide1.addText('Slide 1: Title', { x: 1, y: 1, fontSize: 32, bold: true });
slide1.addShape('rect', { x: 1, y: 2, w: 3, h: 1, fill: { color: 'FF0000' } });

const slide2 = complexPres.addSlide();
slide2.addText('Slide 2: Table', { x: 1, y: 0.5, fontSize: 24, bold: true });
slide2.addTable([
  ['Name', 'Value'],
  ['Test 1', '100'],
  ['Test 2', '200'],
], { x: 1, y: 1.5, w: 5 });

const slide3 = complexPres.addSlide();
slide3.addText('Slide 3: Chart', { x: 1, y: 0.5, fontSize: 24, bold: true });
slide3.addChart('bar', [
  { name: 'Series 1', labels: ['A', 'B', 'C'], values: [10, 20, 30] },
], { x: 1, y: 1.5, w: 6, h: 4 });

try {
  const complexBase64 = await complexPres.write({ outputType: 'base64' });
  console.log(`âœ… Complex presentation generated`);
  console.log(`   Slides: 3`);
  console.log(`   Size: ${Math.round(complexBase64.length / 1024)} KB`);
  
  // Save complex presentation
  const binaryString = atob(complexBase64);
  const bytes = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  writeFileSync('/workspaces/pptxgenjs-mcp/test/test-complex.pptx', bytes);
  console.log('âœ… Complex file saved to test/test-complex.pptx');
  
} catch (error) {
  console.log(`âŒ Complex presentation failed: ${error.message}`);
  console.error(error);
}

console.log('\nâœ… All PPTX generation tests completed!\n');
console.log('ðŸ“ Summary:');
console.log('  - PPTX files saved to test/ directory');
console.log('  - You can open them to verify they work correctly');
console.log('  - Base64 export is working');
console.log('  - Different output types are supported\n');
